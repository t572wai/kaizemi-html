<!DOCTYPE html>
<html lang="jp" dir="ltr">
	<head>
		<meta charset="utf-8">
		<meta name="robots" content="noindex"/>
		<title>轢きたかし</title>
		<script src="https://code.jquery.com/jquery-3.0.0.min.js"></script>
		<script src="https://code.jquery.com/ui/1.12.0/jquery-ui.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui-touch-punch/0.2.3/jquery.ui.touch-punch.min.js"></script>
		<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/redmond/jquery-ui.css">
		<script type="text/javascript">
			let rates = {};
			let players = new Array();

			$(function () {
				console.log("start");
				$('.takashi').sortable({
					connectWith:'.takashi',
					items: ">*:not(.hidden)"
				});
			});

			$(function () {
				$("#CannotAddPlayerDialog").dialog({
					autoOpen:false,
					modal:false
				})
				$('#addPlayerDialog').dialog({
					autoOpen: false,
					modal: true,
					width:440,
					buttons: [
						{
							text: "追加",
							click: function () {
								let newPlayerName = $('#newPlayerName').val();
								if(1==canAddPlayer(newPlayerName)){
									players.push(newPlayerName);
									let newPlayerRate = $('#newPlayerRate').val();
									if(Number.isInteger(parseFloat(newPlayerRate))){
										newPlayerRate = Math.floor(newPlayerRate);
										newPlayerRate+='.0';
									}
									rates[newPlayerName]=newPlayerRate;
									$('#newPlayerName').val("");
									$(this).dialog('close');
									updateDate();
									$('#newPlayerRate').attr('value',1.0);
								}else {
									console.log(newPlayerName);
									$('#CannotAddPlayerDialog').text('プレイヤーを追加できません')
									$('#CannotAddPlayerDialog').dialog('open');
								}
							}
						}
					]
				})
			})

			function updateDate() {
				let playersHTML = "";
				for (name of players) {
					playersHTML += '<li>'+name+'</li>';
				}
				players.sort(function (a,b) {
					if(rates[a]>=rates[b]){
						return -1;
					}else {
						return 1;
					}
				});
				console.log(rates);
				console.log(players);
				let ratesHTML = "";
				let i = 1;
				let beforeRate = 0;
				let ran = 0;
				for(name of players){
					if(beforeRate!=rates[name]){
						rank = i;
					}else {
						rank;
					}
					i++;
					beforeRate = rates[name];
					if(Number.isInteger(parseFloat(rates[name]))){
						rates[name] = Math.floor(rates[name]);
						rates[name]+='.0';
					}
					ratesHTML += rank + '位:' + name + " レート:" + rates[name] + '<br>';
				}
				$('#rates').html(ratesHTML);
				$('#players').html(playersHTML+"<li class='hidden'>&nbsp;</li>");
				$('#hayashi').html('<li class="hidden">&emsp;</li>')
			}

			function updateRate() {
				let n = $('#players > *').length-1;
				let rateUGOKU;
				if(n>3 && n<10){
					switch (n) {
						case 9:rateUGOKU = [0.7,0.4,0.2,0.1,0.0,-0.1,-0.2,-0.4,-0.7];break;
						case 8:rateUGOKU = [0.7,0.4,0.2,0.1,-0.1,-0.2,-0.4,-0.7];break;
						case 7:rateUGOKU = [0.7,0.3,0.1,0.0,-0.1,-0.3,-0.7];break;
						case 6:rateUGOKU = [0.7,0.3,0.1,-0.1,-0.3,-0.7];break;
						case 5:rateUGOKU = [0.7,0.3,0.0,-0.3,-0.7];break;
						case 4:rateUGOKU = [0.7,0.3,-0.3,-0.7];break;
					}
					$('#players > li').each(function (index, element) {
						rates[$(element).text()]=parseFloat(rates[$(element).text()])+parseFloat(rateUGOKU[index]);
						console.log(element,index,rateUGOKU[index],rates[$(element).text()]);
						rates[$(element).text()]=Math.round(parseFloat(rates[$(element).text()])*10)/10
					})
					updateDate();
				}else {
					$('#CannotAddPlayerDialog').text('不正な人数です');
					$('#CannotAddPlayerDialog').dialog('open');
				}

			}

			function addPlayer() {
				$('#addPlayerDialog').dialog('open');
			}

			function canAddPlayer(newPlayerName) {
				if(newPlayerName == null || newPlayerName == "")return 0;
				for (name of players) {
					if(name==newPlayerName)return 0;
				}
				return 1;
			}
		</script>
		<style>
			.Dialog{
				display: none;
			}
			*{
				font-size: 30px;
			}
			h1{
				font-size: 79px;
				background-color: rgba(12, 209, 198, 0.26);
				display: inline-block;
				border-left: 7px solid #124a94;
			}
			li{
				outline: 1px solid;
				width: 400px;
				word-wrap: break-word;
			}
			.hidden{
				outline: none;
				list-style: none;
			}
			button{
				background-color: skyblue;
				border: 3px solid #2f2f2f;
				border-radius: 10px;
			}
			button:hover{
				background-color: white;

			}
		</style>
	</head>
	<body>
		<h1>轢きたかし用レート計算機</h1>
		<button type="button" onclick="addPlayer();">プレイヤーの追加</button>

		<div id="rates">
		</div>
		<span>参加した人の順位</span>
		<ol id="players" class="takashi">
		</ol>
		<br>
		<span>不参加の人</span>
		<ul id="hayashi" class="takashi">
			<li class="hidden">&emsp;</li>
		</ul>
		<button id="setRate" onclick="updateRate();">レート更新</button><br>
		レート<p>
		9:[0.7,0.4,0.2,0.1,0.0,-0.1,-0.2,-0.4,-0.7]<br>
		8:[0.7,0.4,0.2,0.1,-0.1,-0.2,-0.4,-0.7]<br>
		7:[0.7,0.3,0.1,0.0,-0.1,-0.3,-0.7]<br>
		6:[0.7,0.3,0.1,-0.1,-0.3,-0.7]<br>
		5:[0.7,0.3,0.0,-0.3,-0.7]<br>
		4:[0.7,0.3,-0.3,-0.7]
	</p>
		<div id="addPlayerDialog" class="Dialog" title="プレイヤーの追加">
			プレイヤーを追加<br>
			名前　<input type="text" value="" id="newPlayerName"><br>
			レート<input type="number" value="1.0" step="0.1" id="newPlayerRate">
		</div>


		<div id="CannotAddPlayerDialog" class="Dialog" title="エラー">
		</div>
	</body>
</html>
